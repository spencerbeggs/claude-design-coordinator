#!/bin/sh

# Skip pre-commit hook in CI environment
[ -n "$GITHUB_ACTIONS" ] && exit 0

# Re-exec with zsh if not already running in zsh (for GUI git clients like GitKraken)
if [ -z "$ZSH_VERSION" ]; then
  exec /bin/zsh "$0" "$@"
fi

# Skip pre-commit hook during rebase/squash operations (except final commit)
[ -f ".git/rebase-merge/interactive" ] && exit 0
[ -f ".git/rebase-apply/rebasing" ] && exit 0

# Ensure pnpm is in PATH for GUI git clients
# Source user's zsh configuration to get full environment
if [ -f "$HOME/.zshenv" ]; then
  source "$HOME/.zshenv"
fi
if [ -n "$ZDOTDIR" ] && [ -f "$ZDOTDIR/.zshenv" ]; then
  source "$ZDOTDIR/.zshenv"
fi

# Try to source nvm if available
export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Run lint-staged to check and fix staged files
pnpm exec lint-staged --config ./lib/configs/lint-staged.config.js
